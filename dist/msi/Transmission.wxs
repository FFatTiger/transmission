<Wix xmlns="http://wixtoolset.org/schemas/v4/wxs" xmlns:ui="http://wixtoolset.org/schemas/v4/wxs/ui">

  <?include TransmissionConfig.wxi ?>

  <?define ProductName = "Transmission $(var.TrVersionFull) ($(sys.BUILDARCH))" ?>
  <?if $(sys.BUILDARCH) = x64 ?>
    <?define PlatformSystemFolder = "System64Folder" ?>
  <?else ?>
    <?define PlatformSystemFolder = "SystemFolder" ?>
  <?endif ?>

  <Package Name="$(var.ProductName)" UpgradeCode="1FB3C295-9BD4-4248-8C8B-B85CD11FE7C4" Language="1033" Codepage="1252" Version="$(var.TrVersionMsi)" Manufacturer="Transmission Project">
    <SummaryInformation Keywords="Installer" Description="Transmission $(var.TrVersion) Installer" Comments="A Fast, Easy, and Free BitTorrent Client" Manufacturer="Transmission Project" />
    <MajorUpgrade DowngradeErrorMessage="A later version of Transmission is already installed. Setup will now exit." AllowSameVersionUpgrades="yes" />

    <?if $(var.QtMajorVer) = 5 ?>
      <?define MinSystemName = "Windows Vista, Windows Server 2008, or higher" ?>
      <?define MinSystemCondition = "(VersionNT >= 600)" ?>
    <?else ?>
      <!-- https://support.microsoft.com/en-us/help/3202260/versionnt-value-for-windows-10-and-windows-server-2016 -->
      <Property Id="WINDOWSBUILDNUM" Secure="yes">
        <RegistrySearch Id="OsMajorVerRegSearch" Root="HKLM" Key="SOFTWARE\Microsoft\Windows NT\CurrentVersion" Name="CurrentMajorVersionNumber" Type="raw" />
      </Property>
      <?define MinSystemName = "Windows 10, Windows Server 2016, or higher" ?>
      <?define MinSystemCondition = "WINDOWSBUILDNUM" ?>
    <?endif ?>

    <Launch Condition="Installed OR $(var.MinSystemCondition)" Message="This application is only supported on $(var.MinSystemName)." />

    <Property Id="TRQTWINSTALLDIR" Secure="yes">
      <RegistrySearch Id="TrQtWRegSearch" Root="HKLM" Key="SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\Transmission-Qt" Name="InstallLocation" Type="directory" Bitness="always32" />
      <RegistrySearch Id="TrQtWRegSearch64" Root="HKLM" Key="SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\Transmission-Qt" Name="InstallLocation" Type="directory" Bitness="always64" />
    </Property>
    <Launch Condition="NOT TRQTWINSTALLDIR" Message="Another version of Transmission is already installed at &quot;[TRQTWINSTALLDIR]&quot;. Uninstall it first and then try again." />

    <Property Id="UCRTINSTALLED" Secure="yes">
      <DirectorySearch Id="UcrtDirSearch" Path="[$(var.PlatformSystemFolder)]" Depth="0">
        <FileSearch Id="UcrtFileSearch" Name="ucrtbase.dll" MinVersion="6.2.10585.0" />
      </DirectorySearch>
    </Property>
    <Launch Condition="UCRTINSTALLED" Message="The Universal C Runtime is not installed. Please run Windows Update and install all required Windows updates. You can download the UCRT separately from here: https://support.microsoft.com/en-us/kb/2999226" />

    <Property Id="VCREDISTINSTALLED" Secure="yes">
      <RegistrySearch Id="VcRedistInstalledRegSearch" Root="HKLM" Key="SOFTWARE\Microsoft\VisualStudio\$(var.VcVerMajor).0\VC\Runtimes\$(sys.BUILDARCH)" Name="Installed" Type="raw" />
    </Property>
    <Property Id="VCREDISTVERSIONMINOR" Secure="yes">
      <RegistrySearch Id="VcRedistVersionMinorRegSearch" Root="HKLM" Key="SOFTWARE\Microsoft\VisualStudio\$(var.VcVerMajor).0\VC\Runtimes\$(sys.BUILDARCH)" Name="Minor" Type="raw" />
    </Property>
    <Launch Condition="VCREDISTINSTALLED = &quot;#1&quot; AND VCREDISTVERSIONMINOR &gt;= &quot;#$(var.VcVerMinor)0&quot;" Message="The Visual C++ Runtime is not installed or is outdated. Please download and install the latest version from here: https://aka.ms/vs/$(var.VsVerMajor)/release/vc_redist.$(sys.BUILDARCH).exe" />

    <Media Id="1" Cabinet="main.cab" EmbedCab="yes" DiskPrompt="CD-ROM #1" />
    <Property Id="DiskPrompt" Value="Transmission $(var.TrVersion) Installation [1]" />

    <StandardDirectory Id="ProgramFiles6432Folder">
       <Directory Id="INSTALLDIR" Name="Transmission">
        <Directory Id="WEBINSTALLDIR" Name="public_html" />
      </Directory>
    </StandardDirectory>
    <StandardDirectory Id="ProgramMenuFolder" />
    <StandardDirectory Id="DesktopFolder" />

    <Feature Id="CompleteInstall" Title="Transmission" Level="1" AllowAdvertise="no" Display="expand" ConfigurableDirectory="INSTALLDIR">
      <Feature Id="CommonLibs" Level="1" AllowAdvertise="no" Display="hidden">
        <ComponentGroupRef Id="CommonLibsComponents" />
      </Feature>
      <Feature Id="QtClient" Title="Qt client" Description="Native GUI application with local and remote sessions support." Level="1" AllowAdvertise="no">
        <ComponentGroupRef Id="QtClientComponents" />
      </Feature>
      <Feature Id="Daemon" Title="Daemon" Description="Background service accessible with Qt client, web UI, or remote CLI tool." Level="2" AllowAdvertise="no">
        <ComponentGroupRef Id="DaemonComponents" />
      </Feature>
      <Feature Id="CmdTools" Title="Command-line tools" Description="Various command-line tools useful for scripting (remote, create, edit, show)." Level="2" AllowAdvertise="no">
        <ComponentGroupRef Id="CliToolsComponents" />
      </Feature>
      <Feature Id="WebUi" Title="Web interface" Description="Web UI to access Qt client or daemon via web browser." Level="2" AllowAdvertise="no">
        <ComponentGroupRef Id="WebUiComponents" />
      </Feature>
    </Feature>

    <ui:WixUI Id="WixUI_FeatureTree" />
    <UIRef Id="WixUI_ErrorProgressText" />

    <WixVariable Id="WixUILicenseRtf" Value="$(var.LicenseFile)" />

    <Icon Id="Tr.ico" SourceFile="$(var.IconFile)" />
    <Property Id="ARPPRODUCTICON" Value="Tr.ico" />

    <Property Id="ARPURLINFOABOUT" Value="https://transmissionbt.com/" />
    <Property Id="ARPHELPLINK" Value="https://forum.transmissionbt.com/" />
  </Package>

</Wix>
